<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Hausgeldabrechnung {{ data.year }} - {{ data.einheit.nummer }}</title>
    <style>
        @page {
            margin: 80px 25px 40px 25px;
        }
        
        .page-header {
            font-size: 8pt;
            text-align: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
            margin-bottom: 15px;
            color: #666;
        }
        
        .footer {
            position: fixed;
            bottom: -30px;
            left: 0px;
            right: 0px;
            height: 30px;
            font-size: 7pt;
            text-align: center;
            border-top: 1px solid #ddd;
            padding-top: 5px;
        }
        
        .footer:before {
            content: "Hausgeldabrechnung {{ data.year }} - {{ data.einheit.nummer }} {{ data.einheit.beschreibung }} - Seite " counter(page);
        }
        
        body {
            font-family: Arial, sans-serif;
            font-size: 9pt;
            line-height: 1.3;
            color: #333;
            margin: 0;
            padding: 0;
        }
        
        .page-content {
            max-width: calc(100% - 50px); /* Subtract 25px from each side */
            margin: 0 auto;
            padding: 0 25px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        
        .header h1 {
            font-size: 16pt;
            font-weight: bold;
            margin: 0 0 5px 0;
            text-transform: uppercase;
        }
        
        .meta-info {
            font-size: 8pt;
            color: #666;
            margin-top: 8px;
        }
        
        .section {
            margin-bottom: 20px;
            page-break-inside: avoid;
        }
        
        .section-title {
            font-size: 11pt;
            font-weight: bold;
            background-color: #f5f5f5;
            padding: 5px 8px;
            border-left: 4px solid #333;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .info-grid {
            display: table;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .info-row {
            display: table-row;
        }
        
        .info-label {
            display: table-cell;
            font-weight: bold;
            width: 30%;
            padding: 2px 10px 2px 0;
        }
        
        .info-value {
            display: table-cell;
            padding: 2px 0;
        }
        
        .result-box {
            background-color: #e8f4f8;
            border: 2px solid #2196F3;
            padding: 10px;
            text-align: center;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .result-box .result-text {
            font-size: 12pt;
            font-weight: bold;
            color: #1976D2;
        }
        
        .calculation-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 8pt;
        }
        
        .calculation-table th {
            background-color: #f0f0f0;
            font-weight: bold;
            padding: 6px;
            text-align: center;
            border: 1px solid #ccc;
        }
        
        .calculation-table td {
            padding: 4px 6px;
            border: 1px solid #ddd;
            text-align: right;
        }
        
        .calculation-table td.label {
            text-align: left;
            font-weight: normal;
        }
        
        .cost-table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 8pt;
        }
        
        .cost-table th {
            background-color: #f8f8f8;
            padding: 5px;
            text-align: left;
            border-bottom: 1px solid #333;
            font-weight: bold;
        }
        
        .cost-table td {
            padding: 3px 5px;
            border-bottom: 1px solid #eee;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .cost-table td.amount {
            text-align: right;
            font-family: 'Courier New', monospace;
        }
        
        .cost-table .subtotal {
            font-weight: bold;
            background-color: #f5f5f5;
            border-top: 1px solid #999;
        }
        
        .cost-table .total {
            font-weight: bold;
            background-color: #e8e8e8;
            border-top: 2px solid #333;
            font-size: 9pt;
        }
        
        .payments-table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 8pt;
        }
        
        .payments-table th {
            background-color: #f8f8f8;
            padding: 4px;
            text-align: left;
            border-bottom: 1px solid #333;
            font-weight: bold;
        }
        
        .payments-table td {
            padding: 2px 4px;
            border-bottom: 1px solid #eee;
        }
        
        .payments-table td.date {
            width: 80px;
            text-align: center;
        }
        
        .payments-table td.amount {
            width: 80px;
            text-align: right;
            font-family: 'Courier New', monospace;
        }
        
        .tax-section {
            background-color: #fffbf0;
            border: 1px solid #ffa000;
            padding: 10px;
            margin: 15px 0;
        }
        
        .tax-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 7pt;
            margin: 5px 0;
        }
        
        .tax-table th {
            background-color: #fff3e0;
            padding: 4px;
            text-align: center;
            border: 1px solid #ffb74d;
            font-weight: bold;
        }
        
        .tax-table td {
            padding: 2px 4px;
            border: 1px solid #ffccbc;
            text-align: right;
        }
        
        .tax-table td.label {
            text-align: left;
        }
        
        .footer {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #ccc;
            font-size: 7pt;
            color: #666;
            text-align: center;
        }
        
        .amount {
            font-family: 'Courier New', monospace;
        }
        
        .positive {
            color: #d32f2f;
        }
        
        .negative {
            color: #388e3c;
        }
        
        .page-break {
            page-break-before: always;
        }
        
        .umlageschluessel-table {
            width: 100%;
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 7pt;
        }
        
        .umlageschluessel-table th {
            background-color: #f8f8f8;
            padding: 4px;
            text-align: center;
            border: 1px solid #333;
            font-weight: bold;
        }
        
        .umlageschluessel-table td {
            padding: 3px 4px;
            border: 1px solid #ddd;
            text-align: center;
        }
        
        .umlageschluessel-table td.label {
            text-align: left;
        }
        
        h3, h4 {
            margin-top: 5px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <!-- Page Footer (appears on all pages) -->
    <div class="footer"></div>

    <div class="page-content">
    <div class="header">
        <h1>Hausgeldabrechnung {{ data.year }} - Einzelabrechnung</h1>
        <div class="meta-info">
            Erstellung: {{ generatedAt|date('d.m.Y') }}<br>
            Objekt: {{ data.weg.name }}, {{ data.weg.adresse }}<br>
            Abrechnungszeitraum: 01.01.{{ data.year }} - 31.12.{{ data.year }}
        </div>
    </div>

    <!-- PAGE 1: EIGENTÜMER INFORMATION, ABRECHNUNGSÜBERSICHT, UMLAGESCHLÜSSEL -->
    <div class="section">
        <div class="section-title">Eigentümer Information</div>
        <div class="info-grid">
            <div class="info-row">
                <div class="info-label">Eigentümer:</div>
                <div class="info-value">{{ data.einheit.nummer }} {{ data.einheit.beschreibung }} {{ data.einheit.eigentuemer }}</div>
            </div>
            {% if data.einheit.address %}
            <div class="info-row">
                <div class="info-label">Empfänger-Adresse:</div>
                <div class="info-value">{{ data.einheit.address }}</div>
            </div>
            {% endif %}
        </div>
    </div>

    {% if data.payments %}
    <div class="section">
        <div class="section-title">Abrechnungsübersicht</div>
        
        {# Use centralized calculated_totals from HgaService (BGH V ZR 44/09 compliant) #}
        {% set calc = data.calculated_totals %}
        {% set totalCosts = calc.unit.gesamtkosten %}
        {% set saldo = calc.balance.saldo %}
        
        <div class="result-box">
            <div class="result-text">
                {% if saldo > 0 %}
                    Ergebnis: Nachzahlung in Höhe von {{ saldo|number_format(2, ',', '.') }} €
                {% else %}
                    Ergebnis: Guthaben in Höhe von {{ (saldo * -1)|number_format(2, ',', '.') }} €
                {% endif %}
            </div>
        </div>

        <table class="calculation-table">
            <thead>
                <tr>
                    <th style="text-align: left;">Position</th>
                    <th>Objekt gesamt</th>
                    <th>Ihr Anteil</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="label">Gesamtkosten</td>
                    {# Use centralized calculated_totals (BGH V ZR 44/09 compliant) #}
                    <td class="amount">{{ calc.weg.gesamtkosten|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ calc.unit.gesamtkosten|number_format(2, ',', '.') }} €</td>
                </tr>
                <tr>
                    <td class="label">- Hausgeld-Vorschuss Soll</td>
                    <td class="amount">{{ (data.weg_totals.soll|default(0))|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ (data.payments.soll|default(0))|number_format(2, ',', '.') }} €</td>
                </tr>
                <tr class="subtotal">
                    <td class="label">= Abrechnungsspitze</td>
                    {# Use centralized calculated_totals (BGH V ZR 44/09 compliant) #}
                    <td class="amount">{{ (calc.weg.gesamtkosten - (data.weg_totals.soll|default(0)))|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ calc.balance.abrechnungsspitze|number_format(2, ',', '.') }} € ({{ calc.balance.abrechnungsspitze > 0 ? 'Unterdeckung' : 'Überdeckung' }})</td>
                </tr>
                <tr>
                    <td class="label">Hausgeld-Vorschuss Soll</td>
                    <td class="amount">{{ (data.weg_totals.soll|default(0))|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ (data.payments.soll|default(0))|number_format(2, ',', '.') }} €</td>
                </tr>
                <tr>
                    <td class="label">- Hausgeld-Vorschuss Ist</td>
                    <td class="amount">{{ (data.weg_totals.ist|default(0))|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ (data.payments.ist|default(0))|number_format(2, ',', '.') }} €</td>
                </tr>
                <tr class="subtotal">
                    <td class="label">= Zahlungsdifferenz</td>
                    <td class="amount">{{ ((data.weg_totals.ist|default(0)) - (data.weg_totals.soll|default(0)))|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ ((data.payments.ist|default(0)) - (data.payments.soll|default(0)))|number_format(2, ',', '.') }} € ({{ ((data.payments.ist|default(0)) - (data.payments.soll|default(0))) >= 0 ? 'Überdeckung' : 'Unterdeckung' }})</td>
                </tr>
                <tr class="total">
                    <td class="label">= ABRECHNUNGS-SALDO</td>
                    <td class="amount"></td>
                    <td class="amount">{{ saldo|abs|number_format(2, ',', '.') }} € ({{ saldo > 0 ? 'Nachzahlung' : 'Guthaben' }})</td>
                </tr>
            </tbody>
        </table>
    </div>
    {% endif %}

    <div class="section">
        <div class="section-title">Umlageschlüssel</div>

        <table class="umlageschluessel-table">
            <thead>
                <tr>
                    <th>Nr.</th>
                    <th>Umlageschlüssel</th>
                    <th>Umlage</th>
                    <th>Zeitraum</th>
                    <th>Tage</th>
                    <th>Gesamtumlage</th>
                    <th>Ihr Anteil</th>
                </tr>
            </thead>
            <tbody>
                {% if data.umlageschluessel|default([]) %}
                    {% for schluessel in data.umlageschluessel %}
                    <tr>
                        <td><strong>{{ schluessel.nummer }}</strong></td>
                        <td class="label">{{ schluessel.bezeichnung }}</td>
                        <td>{{ schluessel.umlage_typ }}</td>
                        <td>{{ schluessel.zeitraum }}</td>
                        <td>{{ schluessel.tage }}</td>
                        <td>
                            {% if schluessel.gesamtumlage is same as('Beträge siehe Ergebnisliste') %}
                                Beträge siehe Ergebnisliste
                            {% elseif schluessel.gesamtumlage matches '/^\\d/' %}
                                {{ schluessel.gesamtumlage }}
                            {% else %}
                                {{ schluessel.gesamtumlage }}
                            {% endif %}
                        </td>
                        <td>
                            {% if schluessel.anteil is null %}
                                -
                            {% elseif schluessel.nummer == '05*' %}
                                {{ schluessel.anteil|number_format(4, ',', '.') }}
                            {% else %}
                                {{ schluessel.anteil|number_format(2, ',', '.') }}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- PAGE 2: KOSTENÜBERSICHT -->
    <div class="section page-break">
        <div class="page-header">
            Hausgeldabrechnung {{ data.year }} - {{ data.einheit.nummer }} {{ data.einheit.beschreibung }}
        </div>
        <div class="section-title">Kostenübersicht</div>
        
        <div style="margin-bottom: 20px;">
            <h3>1. Umlagefähige Kosten (Mieter)</h3>
        <table class="cost-table">
            <thead>
                <tr>
                    <th>Kostenart</th>
                    <th style="text-align: center;">Umlageschlüssel</th>
                    <th style="text-align: right;">Gesamtkosten</th>
                    <th style="text-align: right;">Ihr Anteil</th>
                </tr>
            </thead>
            <tbody>
                {% if data.external_costs %}
                <tr class="subtotal">
                    <td colspan="4"><strong>HEIZUNG/WASSER/ABRECHNUNG:</strong></td>
                </tr>
                <tr>
                    <td>ext. berechn. Heizkosten</td>
                    <td style="text-align: center;">01*</td>
                    <td class="amount">{{ data.external_costs.heating.total|default(0)|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ data.external_costs.heating.unit_share|default(0)|number_format(2, ',', '.') }} €</td>
                </tr>
                <tr>
                    <td>ext. berechn. Wasser-/sonst. Kosten</td>
                    <td style="text-align: center;">01*</td>
                    <td class="amount">{{ data.external_costs.water.total|default(0)|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ data.external_costs.water.unit_share|default(0)|number_format(2, ',', '.') }} €</td>
                </tr>
                <tr class="subtotal">
                    <td colspan="2">Zwischensumme: Heizung/Wasser/Abrechnung</td>
                    <td class="amount">{{ ((data.external_costs.heating.total|default(0)) + (data.external_costs.water.total|default(0)))|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ ((data.external_costs.heating.unit_share|default(0)) + (data.external_costs.water.unit_share|default(0)))|number_format(2, ',', '.') }} €</td>
                </tr>
                <tr class="subtotal">
                    <td colspan="4"><strong>SONSTIGE UMLAGEFÄHIGE KOSTEN:</strong></td>
                </tr>
                {% endif %}
                
                {% for item in data.costs.umlagefaehig.items|default([]) %}
                {% if item.total|default(0) > 0 %}
                <tr>
                    <td>{{ item.kostenkonto }} - {{ item.beschreibung }}</td>
                    <td style="text-align: center;">{{ item.verteilungsschluessel|default('05*') }}</td>
                    <td class="amount">{{ item.total|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ item.anteil|number_format(2, ',', '.') }} €</td>
                </tr>
                {% endif %}
                {% endfor %}
                
                {% set sonstigeTotal = 0 %}
                {% set sonstigeAnteil = 0 %}
                {% for item in data.costs.umlagefaehig.items|default([]) %}
                    {% if item.total|default(0) > 0 %}
                    {% set sonstigeTotal = sonstigeTotal + item.total %}
                    {% set sonstigeAnteil = sonstigeAnteil + item.anteil %}
                    {% endif %}
                {% endfor %}
                
                <tr class="subtotal">
                    <td colspan="2">Zwischensumme: Sonstige</td>
                    <td class="amount">{{ sonstigeTotal|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ sonstigeAnteil|number_format(2, ',', '.') }} €</td>
                </tr>
                <tr class="total">
                    <td colspan="2">SUMME: umlagefähig (Mieter)</td>
                    <td class="amount">{{ (((data.external_costs.heating.total|default(0)) + (data.external_costs.water.total|default(0))) + sonstigeTotal)|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ (((data.external_costs.heating.unit_share|default(0)) + (data.external_costs.water.unit_share|default(0))) + sonstigeAnteil)|number_format(2, ',', '.') }} €</td>
                </tr>
            </tbody>
        </table>
    </div>

        <div style="margin-top: 15px; margin-bottom: 20px;">
            <h3>2. Nicht umlagefähige Kosten (Mieter)</h3>
        <table class="cost-table">
            <thead>
                <tr>
                    <th>Kostenart</th>
                    <th style="text-align: center;">Umlageschlüssel</th>
                    <th style="text-align: right;">Gesamtkosten</th>
                    <th style="text-align: right;">Ihr Anteil</th>
                </tr>
            </thead>
            <tbody>
                {% set nichtUmlagefaehigTotal = 0 %}
                {% set nichtUmlagefaehigAnteil = 0 %}
                {% for item in data.costs.nicht_umlagefaehig.items|default([]) %}
                <tr>
                    <td>{{ item.kostenkonto }} - {{ item.beschreibung }}</td>
                    <td style="text-align: center;">{{ item.verteilungsschluessel|default('05*') }}</td>
                    <td class="amount">{{ item.total|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ item.anteil|number_format(2, ',', '.') }} €</td>
                </tr>
                {% set nichtUmlagefaehigTotal = nichtUmlagefaehigTotal + item.total %}
                {% set nichtUmlagefaehigAnteil = nichtUmlagefaehigAnteil + item.anteil %}
                {% endfor %}
                <tr class="total">
                    <td colspan="2">SUMME: nicht umlagefähig (Mieter)</td>
                    <td class="amount">{{ nichtUmlagefaehigTotal|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ nichtUmlagefaehigAnteil|number_format(2, ',', '.') }} €</td>
                </tr>
            </tbody>
        </table>
    </div>

        {# Rücklagen are shown in ZAHLUNGSÜBERSICHT, not here (BGH V ZR 44/09) #}

        <!-- Final cost summary -->
        {% set finalWegUmlagefaehig = ((data.external_costs.heating.total|default(0)) + (data.external_costs.water.total|default(0))) + 0 %}
        {% for item in data.costs.umlagefaehig.items|default([]) %}
            {% set finalWegUmlagefaehig = finalWegUmlagefaehig + item.total %}
        {% endfor %}
        
        {% set finalUnitUmlagefaehig = ((data.external_costs.heating.unit_share|default(0)) + (data.external_costs.water.unit_share|default(0))) + 0 %}
        {% for item in data.costs.umlagefaehig.items|default([]) %}
            {% set finalUnitUmlagefaehig = finalUnitUmlagefaehig + item.anteil %}
        {% endfor %}
        
        {% set finalWegNichtUmlagefaehig = 0 %}
        {% for item in data.costs.nicht_umlagefaehig.items|default([]) %}
            {% set finalWegNichtUmlagefaehig = finalWegNichtUmlagefaehig + item.total %}
        {% endfor %}
        
        {% set finalUnitNichtUmlagefaehig = 0 %}
        {% for item in data.costs.nicht_umlagefaehig.items|default([]) %}
            {% set finalUnitNichtUmlagefaehig = finalUnitNichtUmlagefaehig + item.anteil %}
        {% endfor %}
        
        {# Use centralized calculated_totals from HgaService (BGH V ZR 44/09 compliant) #}

        <div style="margin-top: 20px; border-top: 3px solid #333; padding-top: 10px;">
            <table class="cost-table">
                <tbody>
                    <tr class="total" style="font-size: 11pt;">
                        <td colspan="2" style="font-weight: bold; background-color: #f0f0f0;">GESAMTSUMME ALLER KOSTEN</td>
                        <td class="amount" style="font-weight: bold; background-color: #f0f0f0;">{{ calc.weg.gesamtkosten|number_format(2, ',', '.') }} €</td>
                        <td class="amount" style="font-weight: bold; background-color: #f0f0f0;">{{ calc.unit.gesamtkosten|number_format(2, ',', '.') }} €</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    {% if data.payments.monthly_unit_payments|default([]) %}
    <div class="section page-break">
        <div class="page-header">
            Hausgeldabrechnung {{ data.year }} - {{ data.einheit.nummer }} {{ data.einheit.beschreibung }}
        </div>
        <div class="section-title">Zahlungsübersicht {{ data.year }}</div>
        <div class="info-grid">
            <div class="info-row">
                <div class="info-label">Debitor:</div>
                <div class="info-value">{{ data.einheit.nummer }} {{ data.einheit.beschreibung }} {{ data.einheit.eigentuemer }}</div>
            </div>
            <div class="info-row">
                <div class="info-label">Zeitraum:</div>
                <div class="info-value">01.01.{{ data.year }} - 31.12.{{ data.year }}</div>
            </div>
        </div>

        <table class="payments-table">
            <thead>
                <tr>
                    <th>Datum</th>
                    <th>Beschreibung</th>
                    <th style="text-align: right;">WEG Gesamt</th>
                    <th style="text-align: right;">Ihre Zahlung</th>
                </tr>
            </thead>
            <tbody>
                {# Show monthly wohngeld payments #}
                {% set monthlyUnitPayments = data.payments.monthly_unit_payments %}
                {% set monthlyWegIst = data.payments.weg_totals.monthly_weg_ist|default([]) %}
                {% set totalWohngeldUnit = 0 %}
                {% set totalWohngeldWeg = 0 %}
                {% for month in 1..12 %}
                    {% if monthlyUnitPayments[month] is defined and monthlyUnitPayments[month].wohngeld > 0 %}
                        {% set wegTotal = monthlyWegIst[month]|default(0) %}
                        <tr>
                            <td class="date">{{ '%02d'|format(month) }}.{{ data.year }}</td>
                            <td>Wohngeld</td>
                            <td class="amount">{{ wegTotal|number_format(2, ',', '.') }} €</td>
                            <td class="amount">{{ monthlyUnitPayments[month].wohngeld|number_format(2, ',', '.') }} €</td>
                        </tr>
                        {% set totalWohngeldUnit = totalWohngeldUnit + monthlyUnitPayments[month].wohngeld %}
                        {% set totalWohngeldWeg = totalWohngeldWeg + wegTotal %}
                    {% endif %}
                {% endfor %}
                <tr style="border-top: 1px solid #999;">
                    <td colspan="2"></td>
                    <td class="amount"><strong>{{ totalWohngeldWeg|number_format(2, ',', '.') }} €</strong></td>
                    <td class="amount"><strong>{{ totalWohngeldUnit|number_format(2, ',', '.') }} €</strong></td>
                </tr>

                {# Show other payments (Nachzahlungen, Sonderumlagen) #}
                {% set otherPayments = [] %}
                {% for monthData in monthlyUnitPayments %}
                    {% if monthData.other is defined %}
                        {% set otherPayments = otherPayments|merge(monthData.other) %}
                    {% endif %}
                {% endfor %}

                {% set totalOtherUnit = 0 %}
                {% set totalOtherWeg = 0 %}
                {% if otherPayments|length > 0 %}
                <tr><td colspan="4" style="height: 8px;"></td></tr>
                {% set seenCategories = [] %}
                {% set wegCategoryTotals = data.payments.weg_category_totals|default([]) %}
                {% set unitCategoryTotals = {} %}

                {% for payment in otherPayments %}
                    {% set kategorie = payment.kategorie|default('Unbekannt') %}
                    {% set currentUnitTotal = unitCategoryTotals[kategorie]|default(0) %}
                    {% set unitCategoryTotals = unitCategoryTotals|merge({ (kategorie): (currentUnitTotal + payment.betrag) }) %}
                {% endfor %}

                {% for kategorie, unitTotal in unitCategoryTotals %}
                    {% set wegTotal = wegCategoryTotals[kategorie]|default(0) %}
                    <tr>
                        <td class="date">{{ data.year }}</td>
                        <td>{{ kategorie }}</td>
                        <td class="amount">{{ wegTotal|number_format(2, ',', '.') }} €</td>
                        <td class="amount">{{ unitTotal|number_format(2, ',', '.') }} €</td>
                    </tr>
                    {% set totalOtherUnit = totalOtherUnit + unitTotal %}
                    {% set totalOtherWeg = totalOtherWeg + wegTotal %}
                {% endfor %}
                <tr style="border-top: 1px solid #999;">
                    <td colspan="2"></td>
                    <td class="amount"><strong>{{ totalOtherWeg|number_format(2, ',', '.') }} €</strong></td>
                    <td class="amount"><strong>{{ totalOtherUnit|number_format(2, ',', '.') }} €</strong></td>
                </tr>
                {% endif %}

                <tr style="border-top: 2px solid #333;">
                    <td colspan="2"></td>
                    <td class="amount"><strong></strong></td>
                    <td class="amount"><strong>{{ (totalWohngeldUnit + totalOtherUnit)|number_format(2, ',', '.') }} €</strong></td>
                </tr>

                {# Add WEG totals summary #}
                <tr style="border-top: 3px double #333;">
                    <td colspan="4" style="padding-top: 12px; font-weight: bold; font-size: 11pt; background-color: #e8e8e8;">WEG GESAMTSUMMEN:</td>
                </tr>
                <tr style="background-color: #f0f0f0;">
                    <td colspan="3" style="font-weight: bold;">Wohngeld gesamt (WEG):</td>
                    <td class="amount" style="font-weight: bold;">{{ (data.payments.weg_totals.ist|default(0))|number_format(2, ',', '.') }} €</td>
                </tr>

                {# Add Rücklagenzuführung #}
                {% if data.costs.ruecklagen.items|default([]) %}
                <tr style="border-top: 2px solid #ddd;">
                    <td colspan="4" style="padding-top: 12px; font-weight: bold; background-color: #f8f8f8;">RÜCKLAGENZUFÜHRUNG (Einnahmen für Rücklage):</td>
                </tr>
                {% set unitRuecklagen = 0 %}
                {% set wegRuecklagen = data.payments.weg_totals.ruecklagen|default(0) %}
                {% for item in data.costs.ruecklagen.items %}
                <tr>
                    <td class="date">31.12.{{ data.year }}</td>
                    <td>{{ item.beschreibung }}</td>
                    <td class="amount">{{ wegRuecklagen|abs|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ item.anteil|abs|number_format(2, ',', '.') }} €</td>
                </tr>
                {% set unitRuecklagen = unitRuecklagen + item.anteil|abs %}
                {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if data.balance.hasData|default(false) %}
    <div class="section">
        <div class="section-title">Kontostandsentwicklung {{ data.year }}</div>
        {% set wegRuecklagen = data.payments.weg_totals.ruecklagen|default(0) %}
        {% set startTotal = data.balance.startAmount %}
        {% set endTotal = data.balance.endAmount %}
        {% set endRuecklagen = wegRuecklagen|abs %}
        {% set endHausgeld = endTotal - endRuecklagen %}
        {% set startHausgeld = startTotal %}
        {% set startRuecklagen = 0 %}

        <div class="info-grid">
            <div class="info-row">
                <div class="info-label">Kontostand Hausgeld 31.12.{{ data.balance.year - 1 }}:</div>
                <div class="info-value">{{ startHausgeld|number_format(2, ',', '.') }} €</div>
            </div>
            <div class="info-row">
                <div class="info-label">Kontostand Rücklagen 31.12.{{ data.balance.year - 1 }}:</div>
                <div class="info-value">{{ startRuecklagen|number_format(2, ',', '.') }} €</div>
            </div>
            <div class="info-row" style="padding-top: 8px; border-top: 1px solid #ddd;">
                <div class="info-label">Kontostand Hausgeld 31.12.{{ data.balance.year }}:</div>
                <div class="info-value">{{ endHausgeld|number_format(2, ',', '.') }} €</div>
            </div>
            <div class="info-row">
                <div class="info-label">Kontostand Rücklagen 31.12.{{ data.balance.year }}:</div>
                <div class="info-value">{{ endRuecklagen|number_format(2, ',', '.') }} €</div>
            </div>
            <div class="info-row" style="padding-top: 8px; border-top: 1px solid #ddd;">
                <div class="info-label">Veränderung Hausgeld:</div>
                <div class="info-value {{ (endHausgeld - startHausgeld) >= 0 ? 'positive' : 'negative' }}">{{ (endHausgeld - startHausgeld) >= 0 ? '+' : '' }}{{ (endHausgeld - startHausgeld)|number_format(2, ',', '.') }} €</div>
            </div>
            <div class="info-row">
                <div class="info-label">Veränderung Rücklagen:</div>
                <div class="info-value {{ (endRuecklagen - startRuecklagen) >= 0 ? 'positive' : 'negative' }}">{{ (endRuecklagen - startRuecklagen) >= 0 ? '+' : '' }}{{ (endRuecklagen - startRuecklagen)|number_format(2, ',', '.') }} €</div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if data.wirtschaftsplan %}
    <div class="section page-break">
        <div class="page-header">
            Hausgeldabrechnung {{ data.year }} - {{ data.einheit.nummer }} {{ data.einheit.beschreibung }}
        </div>
        {% set planYear = data.year + 1 %}
        <div class="section-title">Vermögensübersicht und Wirtschaftsplan {{ planYear }}</div>
        
        <h3>Vermögensstand:</h3>
        <div class="info-grid" style="margin-bottom: 20px;">
            <div class="info-row">
                <div class="info-label">Kontostand WEG-Hausgeldkonto ({{ data.wirtschaftsplan.bank_balances.balance_date|default('16.07.2025') }}):</div>
                <div class="info-value">{{ data.wirtschaftsplan.bank_balances.hausgeld_konto|default(0)|number_format(2, ',', '.') }} €</div>
            </div>
            <div class="info-row">
                <div class="info-label">Kontostand Rücklagenkonto ({{ data.wirtschaftsplan.bank_balances.balance_date|default('16.07.2025') }}):</div>
                <div class="info-value">{{ data.wirtschaftsplan.bank_balances.ruecklagen_konto|default(0)|number_format(2, ',', '.') }} €</div>
            </div>
            <div class="info-row" style="border-top: 2px solid #333; padding-top: 5px; margin-top: 5px;">
                <div class="info-label"><strong>GESAMTVERMÖGEN WEG:</strong></div>
                <div class="info-value"><strong>{{ ((data.wirtschaftsplan.bank_balances.hausgeld_konto|default(0)) + (data.wirtschaftsplan.bank_balances.ruecklagen_konto|default(0)))|number_format(2, ',', '.') }} €</strong></div>
            </div>
        </div>
        
        <h3 style="margin-top: 20px;">Wirtschaftsplan {{ planYear }} - Geplante Ausgaben:</h3>
        
        <h4>1. Umlagefähige Kosten (auf Mieter umlegbar):</h4>
        <table class="cost-table" style="width: 100%;">
            <colgroup>
                <col style="width: auto;">
                <col style="width: 120px;">
            </colgroup>
            <tbody>
                {% set umlagefaehigTotal = 0 %}
                {% set planNotes = [] %}
                {% for expense in data.wirtschaftsplan.planned_expenses.umlagefaehig|default([]) %}
                <tr>
                    <td>{{ expense.name|default('Unbekannt') }}</td>
                    <td class="amount">{{ expense.amount|default(0)|number_format(2, ',', '.') }} €</td>
                </tr>
                {% if expense.notes|default('') %}
                    {% if expense.notes not in planNotes %}
                        {% set planNotes = planNotes|merge([expense.notes]) %}
                    {% endif %}
                {% endif %}
                {% set umlagefaehigTotal = umlagefaehigTotal + expense.amount|default(0) %}
                {% endfor %}
                <tr class="subtotal">
                    <td>Zwischensumme umlagefähig:</td>
                    <td class="amount">{{ umlagefaehigTotal|number_format(2, ',', '.') }} €</td>
                </tr>
            </tbody>
        </table>
        
        <h4>2. Nicht umlagefähige Kosten:</h4>
        <table class="cost-table" style="width: 100%;">
            <colgroup>
                <col style="width: auto;">
                <col style="width: 120px;">
            </colgroup>
            <tbody>
                {% set nichtUmlagefaehigTotal = 0 %}
                {% for expense in data.wirtschaftsplan.planned_expenses.nicht_umlagefaehig|default([]) %}
                <tr>
                    <td>{{ expense.name|default('Unbekannt') }}</td>
                    <td class="amount">{{ expense.amount|default(0)|number_format(2, ',', '.') }} €</td>
                </tr>
                {% if expense.notes|default('') %}
                    {% if expense.notes not in planNotes %}
                        {% set planNotes = planNotes|merge([expense.notes]) %}
                    {% endif %}
                {% endif %}
                {% set nichtUmlagefaehigTotal = nichtUmlagefaehigTotal + expense.amount|default(0) %}
                {% endfor %}
                <tr class="subtotal">
                    <td>Zwischensumme nicht umlagefähig:</td>
                    <td class="amount">{{ nichtUmlagefaehigTotal|number_format(2, ',', '.') }} €</td>
                </tr>
            </tbody>
        </table>
        
        <table class="cost-table" style="margin-top: 15px; width: 100%;">
            <colgroup>
                <col style="width: auto;">
                <col style="width: 120px;">
            </colgroup>
            <tbody>
                <tr class="total" style="font-size: 10pt;">
                    <td><strong>GESAMTAUSGABEN {{ planYear }}:</strong></td>
                    <td class="amount"><strong>{{ (umlagefaehigTotal + nichtUmlagefaehigTotal)|number_format(2, ',', '.') }} €</strong></td>
                </tr>
                {% for note in planNotes %}
                <tr>
                    <td colspan="2" style="font-size: 8pt; color: #555; padding-top: 4px;">
                        * {{ note }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <h3 style="margin-top: 20px;">Geplante Einnahmen {{ planYear }}:</h3>
        <table class="cost-table" style="width: 100%;">
            <colgroup>
                <col style="width: auto;">
                <col style="width: 120px;">
            </colgroup>
            <tbody>
                {% set monthlyTotal = data.wirtschaftsplan.planned_income.monthly_total|default(1500) %}
                {% set previousYear = data.year %}
                {% set nachzahlungenKey = 'nachzahlungen_' ~ previousYear %}
                {% set nachzahlungen = attribute(data.wirtschaftsplan.planned_income, nachzahlungenKey)|default(0) %}
                {% set yearlyVorschuesse = monthlyTotal * 12 %}
                <tr>
                    <td>Hausgeld-Vorschüsse (12 × {{ monthlyTotal|number_format(2, ',', '.') }} €)</td>
                    <td class="amount">{{ yearlyVorschuesse|number_format(2, ',', '.') }} €</td>
                </tr>
                <tr>
                    <td>Nachzahlungen aus HGA {{ previousYear }}</td>
                    <td class="amount">{{ nachzahlungen|number_format(2, ',', '.') }} €</td>
                </tr>
                <tr class="subtotal">
                    <td><strong>GESAMTEINNAHMEN {{ planYear }}:</strong></td>
                    <td class="amount"><strong>{{ (yearlyVorschuesse + nachzahlungen)|number_format(2, ',', '.') }} €</strong></td>
                </tr>
                <tr class="total" style="font-size: 10pt;">
                    <td><strong>SALDO (Einnahmen - Ausgaben):</strong></td>
                    <td class="amount"><strong>{{ ((yearlyVorschuesse + nachzahlungen) - (umlagefaehigTotal + nichtUmlagefaehigTotal))|number_format(2, ',', '.') }} €</strong></td>
                </tr>
            </tbody>
        </table>
        
        <h3 style="margin-top: 20px;">Hausgeld-Vorschuss {{ planYear }} - Ihr Anteil:</h3>
        {% if '/' in data.einheit.mea %}
            {% set meaParts = data.einheit.mea|split('/') %}
            {% set mea = (meaParts[0] + 0) / (meaParts[1] + 0) %}
        {% else %}
            {% set mea = (data.einheit.mea + 0) / 1000 %}
        {% endif %}
        {% set meaPercent = (mea * 100)|round %}
        {% set monthlyOwnerShare = monthlyTotal * mea %}
        
        <table class="cost-table" style="width: 100%;">
            <thead>
                <tr>
                    <th style="width: 60%;"></th>
                    <th style="text-align: center;">Gesamt WEG</th>
                    <th style="text-align: center;">Ihr Anteil ({{ meaPercent }}%)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Monatlicher Vorschuss WEG gesamt:</td>
                    <td class="amount">{{ monthlyTotal|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ monthlyOwnerShare|number_format(2, ',', '.') }} €</td>
                </tr>
                <tr class="subtotal">
                    <td><strong>Ihr NEUER monatlicher Vorschuss:</strong></td>
                    <td class="amount"></td>
                    <td class="amount"><strong>{{ monthlyOwnerShare|number_format(2, ',', '.') }} €</strong></td>
                </tr>
                <tr>
                    <td>Änderung pro Monat:</td>
                    <td class="amount"></td>
                    <td class="amount">0,00 €</td>
                </tr>
            </tbody>
        </table>
        
        {% if data.configuration.standard_texts.balance_notice|default(false) %}
        <div style="margin-top: 15px; padding: 10px; background-color: #f5f5f5; border-left: 4px solid #888;">
            <p style="margin: 0;">{{ data.configuration.standard_texts.balance_notice }}</p>
            {% if data.configuration.standard_texts.balance_notice_2|default(false) %}
            <p style="margin: 5px 0 0 0;">{{ data.configuration.standard_texts.balance_notice_2 }}</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% if data.tax_deductible.items|default([]) %}
    <div class="section page-break">
        <div class="page-header">
            Hausgeldabrechnung {{ data.year }} - {{ data.einheit.nummer }} {{ data.einheit.beschreibung }}
        </div>
        <div class="tax-section">
            <div class="section-title">Steuerbegünstigte Leistungen nach §35a EStG</div>
            <table class="tax-table">
            <thead>
                <tr>
                    <th>Handwerkerleistungen</th>
                    <th>Gesamtkosten</th>
                    <th>anrechenbar</th>
                    <th>Ihr Anteil (Kosten)</th>
                    <th>Ihr Anteil (anrechenbar)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in data.tax_deductible.items %}
                <tr>
                    <td class="label">{{ item.kostenkonto }} - {{ item.beschreibung }} {{ item.verteilungsschluessel }}</td>
                    <td class="amount">{{ item.gesamtkosten|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ item.anrechenbar|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ item.anteil_kosten|number_format(2, ',', '.') }} €</td>
                    <td class="amount">{{ item.anteil_anrechenbar|number_format(2, ',', '.') }} €</td>
                </tr>
                {% endfor %}
                <tr class="total">
                    <td class="label"><strong>SUMME Handwerkerleistungen</strong></td>
                    {% set totalGesamtkosten = data.tax_deductible.items|reduce((sum, item) => sum + item.gesamtkosten, 0) %}
                    {% set totalAnrechenbar = data.tax_deductible.items|reduce((sum, item) => sum + item.anrechenbar, 0) %}
                    {% set totalAnteilKosten = data.tax_deductible.items|reduce((sum, item) => sum + item.anteil_kosten, 0) %}
                    <td class="amount"><strong>{{ totalGesamtkosten|number_format(2, ',', '.') }} €</strong></td>
                    <td class="amount"><strong>{{ totalAnrechenbar|number_format(2, ',', '.') }} €</strong></td>
                    <td class="amount"><strong>{{ totalAnteilKosten|number_format(2, ',', '.') }} €</strong></td>
                    <td class="amount"><strong>{{ data.tax_deductible.total_anrechenbar|number_format(2, ',', '.') }} €</strong></td>
                </tr>
            </tbody>
        </table>
        
        <div style="margin-top: 15px; padding: 10px; background-color: #e3f2fd; border-left: 4px solid #2196F3;">
            <strong>Ihr steuerlich absetzbarer Betrag (100% der Arbeits-/Fahrtkosten inkl. MwSt.): {{ data.tax_deductible.total_anrechenbar|number_format(2, ',', '.') }} EUR</strong>
        </div>
        
        <div style="margin-top: 10px; font-size: 8pt; color: #666;">
            <strong>HINWEIS:</strong> Diese Beträge können Sie in Ihrer Steuererklärung als haushaltsnahe
            Dienstleistungen geltend machen (20% davon, max. 1.200 EUR Steuerermäßigung pro Jahr).
        </div>
        </div>
    </div>
    {% endif %}

    </div> <!-- Close page-content -->
</body>
</html>
